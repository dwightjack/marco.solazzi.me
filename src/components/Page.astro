---
import Stack from './Stack.astro';

export interface Props {
  id: string;
  mark?: string;
  indent?: boolean;
}

const { id, mark, indent = true } = Astro.props;
---

<Stack class:list={['c-page', { 'c-page--indent': indent }]} id={id} space={15}>
  <slot />
  {
    mark && (
      <span class="c-page__mark" aria-hidden="true">
        {mark}
      </span>
    )
  }
</Stack>
<style>
  @layer components {
    @supports (animation-timeline: view()) {
      .c-page {
        --visible: 0;

        animation:
          visible steps(1) both,
          invisible steps(1) both;
        animation-timeline: view();
        animation-range:
          entry 40% cover 10%,
          exit 30% contain 0%;
      }
    }

    .c-page.c-page--indent {
      padding-inline: var(--space-page-gutter-inline);
    }

    .c-page__mark {
      position: fixed;
      z-index: var(--layer-b1);
      transition: all 750ms ease-out;
      transition-property: opacity, translate;
      opacity: calc(0.05 * var(--visible, 0));
      font-size: max(300px, 80vmin);
      white-space: nowrap;
      will-change: opacity, translate;

      @media not screen and (--viewport-tablet) {
        inset-block-start: -40vw;
        inset-inline-end: -10vh;
        writing-mode: vertical-rl;
      }

      @media (--viewport-tablet) {
        inset-block-end: -20vh;
        inset-inline-start: 20vw;
      }

      @media (prefers-reduced-motion: no-preference) {
        /*
          If animation-timeline is supported --visible is toggled between 0 and 1,
          transitioning the translate between 1vw and 0.
          In all other cases, fallbacks to a static computed value of 1vw
        */
        translate: calc(1vw - var(--visible, 0) * 1vw) 0;
      }
    }

    /* Does not supports CSS scroll animations timeline via the view() function */
    @supports not (animation-timeline: view()) {
      /*
     .is-current is only added by JS
      when animation-timeline: view() is not supported
     */
      .c-page.is-current .c-page__mark {
        translate: 0 0;
        opacity: 0.05;
      }

      /**
        JS is disabled as well: hide the mark altogether
      */
      @media (scripting: none) {
        .c-page__mark {
          display: none;
        }
      }
    }

    @keyframes invisible {
      to {
        --visible: 0;
      }
    }

    @keyframes visible {
      to {
        --visible: 1;
      }
    }
  }
</style>
<script>
  import { currentRoute } from '../shared/store';

  if (CSS.supports('animation-timeline: view()') === false) {
    const pages = document.querySelectorAll('.c-page');
    currentRoute.subscribe((route) => {
      for (const page of pages) {
        page.classList.toggle('is-current', page.id === route);
      }
    });
  }
</script>
